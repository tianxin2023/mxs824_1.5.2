/* Copyright (C) 2018 - 2020 Dolphin Interconnect Solutions AS. All rights reserved */
var pfx_config;var config={};var server;var versions;var osinfo;var voltage={};var temperatures={};var fans=[];var errors=[];var update_timer;var poll_timer;var poll_cb;var listener_group_sel;var listener_type_sel;var listener_topology_sel;var allow_api_failure=0;var asked_reboot=0;var extend=0;var portStates=[];var form_callbacks={"pfx-reset":pcie_reset_switch,"fw-upgrade":fw_upload,"fw-auto-upgrade":fw_autoupgrade,"admin-pwd":fw_passwd,pfxUpdateAvail:pfx_update_avail,"pfx-mgmt":pfx_mgmt,"pfx-upload":pfx_upload,"ipv4-cfg":ipv4_config,"ipv6-cfg":ipv6_config,"ntp-cfg":ntp_config,hostname:change_hostname,reboot:reboot,"fw-channel":change_channel,"factory-reset":factory_reset};function find_parent(e,t){var r=e;while(r){r=r.parentNode;if(t===r.nodeName){break}}return r}function disable(e,t){var r;if(!Array.isArray(e)){e=[e]}for(r=0;r<e.length;++r){e[r].setAttribute("disabled","disabled");if(t){e[r].value=""}}}function enable(e){var t;if(!Array.isArray(e)){e=[e]}for(t=0;t<e.length;++t){e[t].removeAttribute("disabled")}}function stop_update_timer(){if(update_timer){window.clearTimeout(update_timer);update_timer=undefined}}function start_update_timer(){if(update_timer==undefined){update_timer=window.setTimeout(load_config,1e3)}}function poll_progress(e){if(e&&typeof e==="function"){poll_cb=e}load_status(function(e){if(e==401){window.location.replace("/login.html");return}if(e&&!allow_api_failure){var t=0;if(e!=404){start_update_timer();t=1}popup_error("Error","Lost connection to API: "+e,t);return}if(server.busy){popup_set_progress(server.state,server.progress,server.details);poll_timer=window.setTimeout(poll_progress,1e3)}else if(server.state=="error"){popup_error("Error","Operation failed: "+server.progress,1);if(poll_cb){poll_cb(1);poll_cb=undefined}allow_api_failure=0;start_update_timer()}else{popup("Success","Operation completed successfully",1);update_pfx_vars("ns-active",config.activeConfig);if(poll_cb){poll_cb();poll_cb=undefined}allow_api_failure=0;start_update_timer()}})}function pfx_update_avail(e){if(!config.hasOwnProperty("pfxUpdateAvailable")){return}document.getElementById("pfx-sel-name").value=config.pfxUpdateAvailable;update_pfx_sel();pfx_cfg_burn()}function pfx_mgmt(e){if(document.activeElement.id==="btn-burn"){pfx_cfg_burn()}else if(document.activeElement.id==="btn-delete"){pfx_cfg_delete()}}function pfx_cfg_burn(){var t=document.getElementById("pfx-sel-name").value;if(t==-1){popup_error("No configuration selected","Please select a valid configuration.",1);return}popup_select("Warning","Changing the configuration will reset the PCIe switch, halting all traffic, "+"and should not be done in a production environment. You must NOT turn off the switch "+"or leave this page during the burn operation. Are you sure you want to continue?",function(e){if(!e){return}stop_update_timer();popup("Burn in progress!","Do not turn off the switch or leave this page");ajax({url:"/api/pfx/burn/"+t,type:"POST",headers:{Authorization:"bearer "+get_token()},success:function(e,t){poll_cb=load_config;poll_timer=window.setTimeout(poll_progress,1e3)},error:function(e){popup_error("Error "+e,"Failed to perform the burn operation.",1);start_update_timer()}})})}function pfx_upload_guess_values(){if(!this.files||!this.files.length||!this.files[0].name){return}var e=this.files[0].name;var t=e.toLowerCase();var r="version";var n=t.indexOf(r);var a="_port";var o=t.indexOf(a);var i=t.search(/(x|X)\d{1}/);if(n===-1){r="ver";n=t.indexOf(r)}if(o===-1){a="port";o=t.indexOf(a)}if(t.indexOf("ntb")!==-1){document.getElementById("cfg-upload-type").value="NTB"}else if(t.indexOf("transp")!==-1){document.getElementById("cfg-upload-type").value="Transparent"}if(t.indexOf("dual")!==-1){document.getElementById("cfg-upload-topology").value="Dual"}else if(t.indexOf("cascade")!==-1){document.getElementById("cfg-upload-topology").value="Cascade"}else{document.getElementById("cfg-upload-topology").value="Single"}document.getElementById("cfg-upload-name").value=e;if(e.length){enable(document.getElementById("btn-upload"))}else{disable(document.getElementById("btn-upload"))}if(n!==-1){var s=parseInt(t.substring(n+r.length));if(!isNaN(s)){var p=parseInt(t.substring(n+r.length+s.toString().length+1));if(!isNaN(p)){s=s+"."+p}document.getElementById("cfg-upload-ver").value=s}}if(o!==-1){var l;var u=3;while(u){l=parseInt(t.substring(o-u));if(!isNaN(l)){document.getElementById("cfg-upload-ports").value=l;break}--u}}if(t.indexOf("g1")!==-1){document.getElementById("cfg-upload-speed").value="1"}else if(t.indexOf("g2")!==-1){document.getElementById("cfg-upload-speed").value="2"}else{document.getElementById("cfg-upload-speed").value="3"}if(i!==-1){var d=parseInt(t.substring(i+1));if(!isNaN(d)){document.getElementById("cfg-upload-width").value=d}}}function pfx_cfg_delete(){var e;var t=pfx_sel_to_filter();var r=filter_pfx_configs(t);var n="";if(!r.length){return popup_error("Error","No valid configuration selected for delete",1)}for(e=0;e<r.length;++e){if(r[e].hasOwnProperty("protected")&&r[e].protected){return popup_error("Error","One or more of the selected configurations are protected from delete.",1)}n+=r[e].file;if(e+1!=r.length){n+="\n"}}popup_create("","",true,n);popup_select("Warning","Are you sure you want to delete "+r.length+" configuration(s):",function(e){if(!e){return popup_close()}popup("Delete in progress","Please wait while we attempt to delete "+r.length+" configuration files.");ajax({url:"/api/pfx/config",type:"DELETE",data:t,headers:{Authorization:"bearer "+get_token()},success:function(e,t){popup("Success","The selected configuration(s) were deleted successfully.",1);load_pfx_configs(function(e){if(e){return popup_error("Error","Failed to reload PFX configurations: "+e,1)}update_pfx_sel_key("group",{});update_pfx_sel_key("type",{});update_pfx_sel_key("topology",{});update_pfx_sel_key("name",{},1);update_pfx_sel()})},error:function(e,t){popup_error("Error "+e,"Failed to perform the reset operation: "+t.error,1)}})})}function pcie_reset_switch(e){popup_select("Reset PCIe switch","This will interrupt and halt all PCIe traffic. "+"Are you sure you want to proceed?",function(e){if(!e){return}stop_update_timer();popup("Reset in progress","Please wait.");ajax({url:"/api/pfx/reset",type:"POST",data:{reset:"enter"},headers:{Authorization:"bearer "+get_token()},success:function(e,t){var r=window.setTimeout(function(){ajax({url:"/api/pfx/reset",type:"POST",data:{reset:"exit"},headers:{Authorization:"bearer "+get_token()},success:function(e,t){start_update_timer();popup("Success","Switch was successfully reset.",1)},error:function(e){start_update_timer();popup_error("Error "+e,"Failed to perform the reset operation.",1)}})},1e3)},error:function(e){start_update_timer();popup_error("Error "+e,"Failed to perform the reset operation.",1)}})})}function pfx_upload(e){var t;var r=document.getElementById("cfg-upload-file");var n=[];var a=/^[\w.-]+$/;var o=/^[\w-,.]+( [\w-,.]+)*$/;var i=/^[\u0000-\u007F]*$/;var s=/^[0-9.\-d]+$/;var p=/^\d+$/;var l=[["name",o,1],["type",a],["topology",i],["version",s,0,"ver"],["ports",p],["speed",p],["width",p],["description",i,0,"desc"]];if(window.FormData===undefined){popup_error("Outdated Browser","Your web browser is too old to support file uploads. Upgrade or change browser.",1);return}var u=new FormData;var d=e.getElementsByTagName("input");for(t=0;t<d.length;++t){d[t].removeAttribute("class")}if(!r.files||!r.files.length||!r.files[0].name.length||!o.test(r.files[0].name)){n.push("Bad file provided");r.setAttribute("class","error")}else{u.append("file",r.files[0])}for(t=0;t<l.length;++t){var f={id:"cfg-upload-"+(l[t].length==4?l[t][3]:l[t][0]),required:l[t].length>=3?l[t][2]:0,exp:l[t][1],key:l[t][0]};var c=document.getElementById(f.id);if(!f.required&&!c.value.length){continue}if(f.exp.test(c.value)){var g;var _=document.createElement("DIV");_.innerHTML=c.value;u.append(f.key,_.textContent||_.innerText||"")}else{n.push("Bad data for "+f.key+" provided");c.setAttribute("class","error")}}if(n.length){var m="";var v="<br />";for(t=0;t<n.length;++t){m+=n[t]+v}m=m.substring(0,m.length-v.length);popup_error("Bad input",m,1);return}stop_update_timer();popup("Uploading File","Upload in progress, please wait. The upload speed depends on your connection.");ajax({url:"/api/pfx/upload",type:"POST",data:u,dataType:"multipart/form-data",headers:{Authorization:"bearer "+get_token()},success:function(e,t){popup("Upload Successful","File uploaded as "+e.file,1);load_pfx_configs(function(e){if(e){return popup_error("Error","Failed to reload PFX configurations: "+e)}update_pfx_sel_key("group",{});update_pfx_sel_key("type",{});update_pfx_sel_key("topology",{});update_pfx_sel_key("name",{},1);update_pfx_sel()})},error:function(e,t){popup_error("Error","File upload failed: "+t.error,1);start_update_timer()}})}function validate_ipv4_config(e){var t;var r;if(e.type===0){t=["address","netmask","gateway","dns"]}else if(e.type===1){e={type:e.type};t=[]}else if(e.type===2){e={type:e.type,address:e.address};t=["address"]}else{popup_error("Bad config","Unknown config type specified",1);return false}for(r=0;r<t.length;++r){var n=t[r];if(!e.hasOwnProperty(n)||e[n]===undefined){popup_error("Bad config","Missing required input",1);return false}}if(e.hasOwnProperty("address")&&!valid_ipv4_array(e.address)){popup_error("Bad config","Bad IPv4 address provided",1);return false}if(e.hasOwnProperty("netmask")&&!valid_ipv4_array(e.netmask)){popup_error("Bad config","Bad netmask(s) provided",1);return false}if(e.hasOwnProperty("gateway")&&!valid_ipv4_array(e.gateway)){popup_error("Bad config","Bad gateway(s) provided",1);return false}if(e.hasOwnProperty("domain")&&!valid_domain_array(e.domain)){popup_error("Bad config","Bad domain(s) provided",1);return false}if(e.hasOwnProperty("dns")&&!valid_ipv4_array(e.dns)){popup_error("Bad config","Bad DNS provided",1);return false}return true}function ipv4_submit(e){stop_update_timer();popup("Updating IPv4 configuration","Please wait. You may lose access to the management interface.");ajax({url:"/api/network/ip4",type:"POST",data:e,headers:{Authorization:"bearer "+get_token()},success:function(e,t){poll_progress()},error:function(e,t){popup_error("Error ("+e+")","Failed to apply configuration: "+t.error,1);start_update_timer()}})}function ipv4_config(e){var t;var r;var n={address:document.getElementsByName("net-ip4-address")[0].value,netmask:document.getElementsByName("net-ip4-mask")[0].value,gateway:document.getElementsByName("net-ip4-gateway")[0].value,domain:document.getElementsByName("net-dns-domain")[0].value,dns:document.getElementsByName("net-dns-server")[0].value};for(t in n){if(!n.hasOwnProperty(t)){continue}if(n[t]===undefined||!n[t].length){delete n[t];continue}n[t]=trim_str(strip_tags(n[t])).split(",")}n.type=parseInt(document.getElementsByName("net-ip4-config")[0].value);if(!validate_ipv4_config(n)){return}r=document.getElementsByName("net-ip4-config")[0].children[n.type].innerHTML+"<br />";for(t in n){if(t==="type"){continue}if(Array.isArray(n[t])){n[t]=n[t].join(",")}r+=t+": "+n[t]+"<br />"}popup_select("Warning","Please ensure you have provided a valid configuration "+"for your network before proceding. The management interface may become unavailable "+"if you misconfigure the network settings. Current settings:<br /><br />"+r,function(e){if(!e){return}ipv4_submit(n)})}function validate_ipv6_config(e){var t=[];var r;if(e.type===1){t=["address","gateway","dns"]}else if(4>e.type&&e.type>=0){e={type:e.type}}else{popup_error("Bad config","Unknown config type specified",1);return false}for(r=0;r<t.length;++r){var n=t[r];if(!e.hasOwnProperty(n)||e[n]===undefined){popup_error("Bad config","Missing required input",1);return false}}if(e.hasOwnProperty("address")&&!valid_ipv6_array(e.address)){popup_error("Bad config","Bad IPv6 address provided",1);return false}if(e.hasOwnProperty("gateway")&&!valid_ipv6_array(e.gateway)){popup_error("Bad config","Bad gateway(s) provided",1);return false}if(e.hasOwnProperty("domain")&&!valid_domain_array(e.domain)){popup_error("Bad config","Bad domain(s) provided",1);return false}if(e.hasOwnProperty("dns")&&!valid_ipv6_array(e.dns)){popup_error("Bad config","Bad DNS provided",1);return false}return true}function ipv6_submit(e){stop_update_timer();popup("Updating IPv6 configuration","Please wait. You may lose access to the management interface.");ajax({url:"/api/network/ip6",type:"POST",data:e,headers:{Authorization:"bearer "+get_token()},success:function(e,t){poll_progress()},error:function(e,t){popup_error("Error ("+e+")","Failed to apply configuration: "+t.error,1);start_update_timer()}})}function ipv6_config(e){var t;var r;var n={address:document.getElementsByName("net-ip6-address")[0].value,gateway:document.getElementsByName("net-ip6-gateway")[0].value,domain:document.getElementsByName("net-i6dns-domain")[0].value,dns:document.getElementsByName("net-i6dns-server")[0].value};for(t in n){if(!n.hasOwnProperty(t)){continue}if(n[t]===undefined||!n[t].length){delete n[t];continue}n[t]=trim_str(strip_tags(n[t])).split(",")}n.type=parseInt(document.getElementsByName("net-ip6-config")[0].value);if(!validate_ipv6_config(n)){return}r=document.getElementsByName("net-ip6-config")[0].children[n.type].innerHTML+"<br />";for(t in n){if(t==="type"){continue}if(Array.isArray(n[t])){n[t]=n[t].join(",")}r+=t+": "+n[t]+"<br />"}popup_select("Warning","Please ensure you have provided a valid configuration "+"for your network before proceding. The management interface may become unavailable "+"if you misconfigure the network settings. Current settings:<br /><br />"+r,function(e){if(!e){return}ipv6_submit(n)})}function ipv4_init_form(e){var t=document.getElementsByName("net-ip4-config")[0];var r=document.getElementsByName("net-ip4-address")[0];var n=document.getElementsByName("net-ip4-mask")[0];var a=document.getElementsByName("net-ip4-gateway")[0];var o=document.getElementsByName("net-dns-domain")[0];var i=document.getElementsByName("net-dns-server")[0];if(!t){console.error("Missing IPv4 config form");return}if(config.network.ip4.type>=t.length||0>config.network.ip4.type){console.error("Bad network type: "+config.network.ip4.type);config.network.ip4.type=0}if(typeof e==="number"&&e){t.selectedIndex=config.network.ip4.type}switch(t.selectedIndex){case 0:r.value=config.network.ip4.address.join(",");n.value=config.network.ip4.netmask.join(",");a.value=config.network.ip4.gateway.join(",");o.value=config.network.ip4.domain.join(",");i.value=config.network.ip4.dns.join(",");enable([r,n,a,o,i]);break;case 1:disable([r,n,a,o,i],1);break;case 2:r.value=config.network.ip4.address.join(",");enable(r);disable([n,a,o,i],1);break;default:console.error("Unknown network type")}}function ipv6_init_form(e){var t=document.getElementsByName("net-ip6-config")[0];var r=document.getElementsByName("net-ip6-address")[0];var n=document.getElementsByName("net-ip6-gateway")[0];var a=document.getElementsByName("net-i6dns-domain")[0];var o=document.getElementsByName("net-i6dns-server")[0];if(!t){console.error("Missing IPv6 config form");return}if(config.network.ip6.type>=t.length||0>config.network.ip6.type){console.error("Bad network type: "+config.network.ip6.type);config.network.ip6.type=0}if(typeof e==="number"&&e){t.selectedIndex=config.network.ip6.type}switch(t.selectedIndex){case 0:case 2:case 3:case 4:disable([r,n,a,o],1);break;case 1:r.value=config.network.ip6.address.join(",");n.value=config.network.ip6.gateway.join(",");a.value=config.network.ip6.domain.join(",");o.value=config.network.ip6.dns.join(",");enable([r,n,a,o]);break;default:console.error("Unknown network type")}}function ntp_config(){var e=document.getElementsByName("net-ntp")[0].value;var t=document.getElementsByName("net-timezone")[0].value;e=trim_str(strip_tags(e)).split(",");t=trim_str(strip_tags(t));if(!valid_ipv4_array(e)&&!valid_ipv6_array(e)&&!valid_domain_array(e)){return popup_error("Error","One or more invalid NTP servers provided.",1)}if(config.network.ntp.timezones.indexOf(t)===-1){return popup_error("Error","Invalid time zone provided.",1)}stop_update_timer();popup("Updating NTP configuration","Please wait.");ajax({url:"/api/network/ntp",type:"POST",data:{server:e.join(","),tz:t},headers:{Authorization:"bearer "+get_token()},success:function(e,t){poll_progress()},error:function(e,t){popup_error("Error ("+e+")","Failed to apply configuration: "+t.error,1);start_update_timer()}})}function ntp_init_form(){var e;var t=document.getElementsByName("net-ntp")[0];var r=document.getElementsByName("net-timezone")[0];t.value=config.network.ntp.servers.join(",");if(config.network.ntp.hasOwnProperty("timezones")&&config.network.ntp.timezones.length){r.innerHTML=""}else{return}for(e=0;e<config.network.ntp.timezones.length;++e){var n=document.createElement("option");n.innerHTML=config.network.ntp.timezones[e];if(config.network.ntp.timezone==config.network.ntp.timezones[e]){n.setAttribute("selected","selected")}r.appendChild(n)}}function apt_init_form(){var e;var t=document.getElementsByName("channel")[0];if(!config.apt||!config.apt.hasOwnProperty("channels")||!config.apt.hasOwnProperty("active")||!config.apt.channels.length){console.error("Bad apt channel data");return}t.innerHTML="";for(e=0;e<config.apt.channels.length;++e){if(config.apt.channels[e].hasOwnProperty("hidden")&&config.apt.channels[e].hidden&&!extend&&config.apt.active!=e){continue}var r=document.createElement("option");r.value=e;r.innerHTML=config.apt.channels[e].name;if(e==config.apt.active){var n=document.getElementsByName("custom")[0];r.selected=1;if(config.apt.channels[e].hasOwnProperty("modify")&&config.apt.channels[e].modify){n.value=config.apt.channels[e].url;n.setAttribute("type","text")}}t.appendChild(r)}t.addEventListener("change",function(e){var t=document.getElementsByName("custom")[0];var r=parseInt(e.target.value);if(isNaN(r)||0>r||r>config.apt.channels.length){console.error("Invalid apt channel selected");return}if(config.apt.channels[r].hasOwnProperty("modify")&&config.apt.channels[r].modify){t.value=config.apt.channels[r].url;t.setAttribute("type","text")}else{t.value="";t.setAttribute("type","hidden")}})}function fw_upgrade_complete(){popup_onclose(function(){window.location.reload(true)});popup("Upgrade complete","It's recommended that you perform a hard refresh of the page. If the update included new PFX "+"configuration(s), the configuration will not be activated automatically. You need to select and change to the new "+"configuration under the PCIe tab after refreshing the page.",1);document.getElementById("popup").getElementsByTagName("button")[0].innerHTML="Refresh page"}function fw_trigger_upgrade(e){if(!e||e.indexOf("No updates available")!==-1){popup("Checking for updates","No updates available.",1);start_update_timer();return}popup_set_progress("Checking for updates",-1,e);popup_select("Firmware upgrade available","Do you want to install the available upgrades? "+"This may update the management kernel, management backend, management GUI, system "+"configuration, available PFX configurations and hardware firmware if updates are "+"available for the specific components. An upgrade should take between 3 - 30 minutes.",function(e){if(!e){start_update_timer();return}popup("Applying updates","Please wait.");ajax({url:"/api/upgrade/auto",type:"POST",headers:{Authorization:"bearer "+get_token()},success:function(e,t){popup("Updating","Upgrade in progress. Please wait, the upgrade should complete within 3 - 30 minutes.");allow_api_failure=1;poll_progress(fw_upgrade_complete)},error:function(e,t){popup_error("Error ("+e+")","Failed to apply updates: "+t,1);start_update_timer()}})})}function fw_autoupgrade(e){stop_update_timer();popup("Checking for updates","Checking for updates, please wait.");popup_set_progress("Retrieving updates",-1);ajax({url:"/api/upgrade/changelog",type:"POST",headers:{Authorization:"bearer "+get_token()},success:function(e,t){fw_trigger_upgrade(e.details)},error:function(e,t){popup_error("Error ("+e+")",t.hasOwnProperty("error")?t.error:t,1);start_update_timer()}})}function fw_upload(e){var t=e.getElementsByTagName("input")[0];if(!t||!t.value.length){popup_error("Error","Please select a file first",1);return}if(window.FormData===undefined){popup_error("Outdated Browser","Your web browser is too old to support file uploads. Upgrade or change browser.",1);return}var r=new FormData;r.append("zip",t.files[0]);popup_select("Firmware upgrade","This will upgrade the management processor. "+"This may update the management kernel, management backend, management GUI, system "+"configuration, available PFX configurations and hardware firmware if updates are "+"available for the specific components. An upgrade should take between 3 - 30 minutes. "+"Do not close this page or power down the switch. "+"Are you sure you want to proceed?",function(e){if(!e){return}stop_update_timer();popup("Uploading File","Upload in progress, please wait. The upload should complete within a few seconds depending on your connection.");ajax({url:"/api/upgrade",type:"POST",data:r,dataType:"application/form-data",headers:{Authorization:"bearer "+get_token()},success:function(e,t){popup("Updating","Upgrade in progress. Please wait, the upgrade should complete within 3 - 30 minutes.");allow_api_failure=1;poll_progress()},error:function(e){popup_error("Error","File upload failed: "+e,1);start_update_timer()}})})}function fw_passwd(e){var t=e.getElementsByTagName("input")[0];var r=e.getElementsByTagName("input")[1];var n=e.getElementsByTagName("input")[2];var a=e.getElementsByTagName("button")[0];if(!r||!r.value.length||!t||!t.value.length){popup_error("Error","Please ensure you fill all password fields",1);return}if(t.value===r.value){popup_error("Error","New password is the same as old password",1);return}if(r.value!==n.value){popup_error("Error","Password mismatch. Ensure both passwords are the same.",1);return}disable(a);ajax({url:"/api/user/passwd",type:"POST",data:{pwd:r.value,old:t.value},headers:{Authorization:"bearer "+get_token()},success:function(e,t){set_token(e.token);popup("Success","Password changed successfully",1)},error:function(e,t){if(t.hasOwnProperty("error")){t=t.error}popup_error("Error ("+e+")","Failed to change password: "+t,1)},done:function(){enable(a)}})}function change_hostname(e){var t=e.getElementsByTagName("input")[0];var r=e.getElementsByTagName("button")[0];if(!t||!t.value.length){popup_error("Error","Please enter a valid hostname",1);return}disable(r);ajax({url:"/api/network/hostname",type:"POST",data:{hostname:t.value},headers:{Authorization:"bearer "+get_token()},success:function(e,t){popup("Success","Hostname changed successfully",1)},error:function(e,t){if(t.hasOwnProperty("error")){t=t.error}popup_error("Error ("+e+")","Failed to change hostname: "+t,1)},done:function(){enable(r)}})}function reboot(e,r){var n=e.getElementsByTagName("button")[0];popup_select("Reboot","This will reboot the management processor. Are you sure you want to proceed?",function(e){if(!e){return}disable(n);stop_update_timer();ajax({url:"/api/reboot",type:"POST",headers:{Authorization:"bearer "+get_token()},success:function(e,t){popup("Working","Reboot is in progress. Please wait, the reboot should complete within 30-60 seconds.");allow_api_failure=1;poll_progress(function(){enable(n);if(r){window.location.reload(true)}})},error:function(e,t){if(t.hasOwnProperty("error")){t=t.error}popup_error("Error ("+e+")","Failed to perform reboot: "+t,1);start_update_timer();enable(n)}})})}function poweroff(e){var r=e.getElementsByTagName("button")[0];popup_select("Poweroff","This will shut down the management processor. "+"You will have to manually power cycle the entire switch to bring "+"the management interface back online. All other hardware will "+"remain active; Fans, LEDs, PFX chip and PCIe traffic. "+"Are you sure you want to proceed?",function(e){if(!e){return}disable(r);stop_update_timer();ajax({url:"/api/poweroff",type:"POST",headers:{Authorization:"bearer "+get_token()},success:function(e,t){popup("Working","Poweroff is in progress. Please wait, you will lose access to the GUI.");poll_progress()},error:function(e,t){if(t.hasOwnProperty("error")){t=t.error}popup_error("Error ("+e+")","Failed to perform poweroff: "+t,1);start_update_timer();enable(r)}})})}function change_channel(e){var n=e.getElementsByTagName("button")[0];var t=document.getElementsByName("channel")[0];var a=parseInt(t.value);if(isNaN(a)||0>a||a>=config.apt.channels.length){console.error("invalid channel selected");return}disable(n);popup_select("Change update channel","This will change the active update channel. "+"Note that this should only be done if instructed by Dolphin, and that you may "+"not be able to downgrade back to the stable release. Are you sure?",function(e){if(!e){enable(n);return}popup("Updating channel","Please wait.");var r={};if(config.apt.channels[a].hasOwnProperty("modify")&&config.apt.channels[a].modify){var t=/^[a-zA-Z0-9:,.\/\\?#&=]*$/;r["url"]=document.getElementsByName("custom")[0].value;if(!t.test(r.url)){enable(n);popup_error("Bad input data","The provided update channel is invalid",1);return}}stop_update_timer();ajax({url:"/api/upgrade/channel/"+a,type:"POST",headers:{Authorization:"bearer "+get_token()},data:r,success:function(e,t){if(r.hasOwnProperty("url")){config.apt.channels[a].url=r.url}popup("Sucess","Update channel changed to "+config.apt.channels[a].name+": "+config.apt.channels[a].url,1);start_update_timer();enable(n)},error:function(e,t){if(t.hasOwnProperty("error")){t=t.error}popup_error("Error ("+e+")","Failed to change upgrade channel: "+t,1);start_update_timer();enable(n)}})})}function factory_reset(e){var r=e.getElementsByTagName("button")[0];disable(r);popup_select("Factory reset","This will restore the switch back to its default manufacturing configuration "+"and settings. All user customizations and data will be lost. PCIe traffic will be interrupted "+"during the process and you will be logged out of the management interface. Are you entirely sure?",function(e){if(!e){enable(r);return}stop_update_timer();ajax({url:"/api/upgrade/reset/",type:"POST",headers:{Authorization:"bearer "+get_token()},success:function(e,t){popup("Success","Factory reset initiated. You will lose access to the interface shortly.");poll_progress()},error:function(e,t){if(t.hasOwnProperty("error")){t=t.error}popup_error("Error ("+e+")","Failed to perform factory reset: "+t,1);start_update_timer();enable(r)}})})}function logout(){stop_update_timer();ajax({url:"/api/logout",type:"POST",headers:{Authorization:"bearer "+get_token()},success:function(e,t){delete_token();window.location.replace("/login.html")},error:function(e,t){if(t.hasOwnProperty("error")){t=t.error}popup_error("Error ("+e+")","Failed to log out: "+t,1);start_update_timer()}})}function displayErrors(e){e.preventDefault();var t;var r="";for(t in errors){if(errors.hasOwnProperty(t)){r+=errors[t]+"<br />"}}popup_error("Active Warnings",r,1)}function load_page(e){var t;var r=document.getElementById("content");var n=document.getElementById("header").getElementsByTagName("a");if(e===undefined||e.trim()===""){e="home"}var a=document.getElementById(e);if(a==null){return}for(t=0;t<r.children.length;++t){if(r.children[t].nodeName==="DIV"){if(r.children[t]===a){r.children[t].setAttribute("style","display: block;")}else{r.children[t].setAttribute("style","display: none;")}}}for(t=0;t<n.length;++t){if(n[t].getAttribute("href")=="#"+e){n[t].parentNode.setAttribute("class","active")}else{n[t].parentNode.removeAttribute("class")}}}function init_page(){var e;var t=document.getElementById("header").getElementsByTagName("a");var r=document.getElementsByTagName("form");document.getElementById("logout").addEventListener("click",function(e){e.preventDefault();logout()});for(e=0;e<t.length;++e){if(t[e].getAttribute("href")[0]!=="#"){continue}t[e].parentNode.addEventListener("click",function(e){e.preventDefault();var t=this.children[0].getAttribute("href").substring(1);push_history(t,"#"+t);load_page(t)},false);t[e].addEventListener("click",function(e){e.preventDefault()},false)}for(e=0;e<r.length;++e){r[e].addEventListener("submit",function(e){e.preventDefault();var t=this.getAttribute("id");if(t&&form_callbacks.hasOwnProperty(t)){form_callbacks[t](this)}},false)}update_pfx_vars("ns-active",config.activeConfig);update_pfx_sel_key("group",{});update_pfx_sel_key("type",{});update_pfx_sel_key("topology",{});update_pfx_sel_key("name",{},1);document.getElementById("pfx-sel-group").addEventListener("change",function(){var e=pfx_sel_to_filter(["type","topology","name"]);update_pfx_sel_key("type",e);update_pfx_sel_key("topology",e);update_pfx_sel_key("name",e,1)});document.getElementById("pfx-sel-type").addEventListener("change",function(){var e=pfx_sel_to_filter(["topology","name"]);update_pfx_sel_key("topology",e);update_pfx_sel_key("name",e,1)});document.getElementById("pfx-sel-topology").addEventListener("change",function(){update_pfx_sel_key("name",pfx_sel_to_filter(["name"]),1)});document.getElementById("pfx-sel-name").addEventListener("change",update_pfx_sel);document.getElementById("cfg-upload-file").addEventListener("change",pfx_upload_guess_values);document.getElementById("cfg-upload-name").addEventListener("input",function(){var e=document.getElementById("cfg-upload-file");if(this.value.length&&e.value.length){enable(document.getElementById("btn-upload"))}else{disable(document.getElementById("btn-upload"))}});if(osinfo.hostname){document.getElementsByName("new-hostname")[0].value=osinfo.hostname}document.getElementsByName("net-ip4-config")[0].addEventListener("change",ipv4_init_form);ipv4_init_form(1);document.getElementsByName("net-ip6-config")[0].addEventListener("change",ipv6_init_form);ipv6_init_form(1);ntp_init_form();apt_init_form();load_page(window.location.hash?window.location.hash.substring(1):undefined)}function update_status(){var e;var t;var r;var n="";var a=[];var o=[];var i=[];var s=[];var p=[];var l=["years","months","weeks","days","hours","minutes","seconds"];ns_var_set("ns-serial",config.serial);ns_var_set("ns-12v",voltage[1].devs[0].val+"V, "+voltage[1].devs[2].val+"A");ns_var_set("ns-09v",voltage[1].devs[1].val+"V, "+voltage[1].devs[3].val+"A");ns_var_set("ns-temp-cpu",temperatures[0].temp);ns_var_set("ns-temp-pfx",temperatures[1].temp);ns_var_set("ns-temp-ext",temperatures[2].temp);ns_var_set("ns-temp-09v",voltage[1].devs[4].str);ns_var_set("ns-temp-coil1",voltage[1].devs[5].str);ns_var_set("ns-temp-coil3",voltage[1].devs[6].str);if(versions.management){ns_var_set("ns-version",versions.management)}if(versions.config){ns_var_set("ns-version-cfg",versions.config)}if(versions.pfx){ns_var_set("ns-version-pfx",versions.pfx)}if(versions.mcu){ns_var_set("ns-version-mcu",versions.mcu)}if(versions.app){ns_var_set("ns-version-app",versions.app)}if(versions.gui){ns_var_set("ns-version-gui",versions.gui)}if(versions.kernel){ns_var_set("ns-version-kernel",versions.kernel)}if(config.serial.charCodeAt(7)>="D".charCodeAt(0)){ns_var_set("ns-33v",voltage[0].devs[0].val+"V, "+voltage[0].devs[1].val+"A")}else{ns_var_set("ns-33v",voltage[0].devs[0].val+"V")}for(e=0;e<fans.length;++e){ns_var_set("ns-fan-"+e,fans[e])}if(osinfo.date){ns_var_set("ns-date",osinfo.date)}t=document.getElementsByClassName("warning")[0];r=errors?Object.keys(errors).length:0;if(r){t.setAttribute("class","warning active");t.setAttribute("title",r+" warnings!");t.addEventListener("click",displayErrors)}else{t.setAttribute("class","warning");t.setAttribute("title","No warnings");t.removeEventListener("click",displayErrors)}for(e=0;e<osinfo.network.length;++e){if(osinfo.network[e].family==="IPv4"){if(o.indexOf(osinfo.network[e].address)===-1){o.push(osinfo.network[e].address)}if(i.indexOf(osinfo.network[e].netmask)===-1){i.push(osinfo.network[e].netmask)}}if(osinfo.network[e].family==="IPv6"){if(a.indexOf(osinfo.network[e].address)===-1){a.push(osinfo.network[e].address)}if(s.indexOf(osinfo.network[e].netmask)===-1){s.push(osinfo.network[e].netmask)}}if(p.indexOf(osinfo.network[e].mac)===-1){p.push(osinfo.network[e].mac)}}for(e=0;e<l.length;++e){if(osinfo.uptime[l[e]]){n+=osinfo.uptime[l[e]]+" "+l[e]+" "}}ns_var_set("ns-hostname",osinfo.hostname);ns_var_set("ns-ipv4",o.length?o.join("<br />"):"-");ns_var_set("ns-netmaskv4",i.length?i.join("<br />"):"-");ns_var_set("ns-ipv6",a.length?a.join("<br />"):"-");ns_var_set("ns-netmaskv6",s.length?s.join("<br />"):"-");ns_var_set("ns-ip",o.concat(a).join("<br />"));ns_var_set("ns-netmask",i.concat(s).join("<br />"));ns_var_set("ns-mac",p.join("<br />"));ns_var_set("ns-uptime",n.substring(0,n.length-1));var u=document.getElementsByClassName("switch-gfx");var d={portStates:portStates,color:{bgColor:"#555",portBorder:"#000",inactive:"#ccc",active:"#00FF00",reduced:"#FFFF00"}};for(e=0;e<u.length;++e){d.canvas=u[e];_draw_switch(d)}}function filter_pfx_configs(e){var t;var r;var n=[];if(Object.keys(e).length==0){return pfx_config}for(r=0;r<pfx_config.length;++r){var a=0;var o=0;for(t in e){++o;if(!pfx_config[r].hasOwnProperty(t)){break}if(pfx_config[r][t]!==e[t]){break}++a}if(a===o){n.push(pfx_config[r])}}return n}function update_pfx_sel_key(e,t,r){var n;var a=document.getElementById("pfx-sel-"+e);var o=filter_pfx_configs(t);var i=document.createDocumentFragment();var s=[];if(!a||!o||t.hasOwnProperty(e)){return}for(n=0;n<o.length;++n){if(o[n].hasOwnProperty(e)&&(r||s.indexOf(o[n][e])===-1)){var p=document.createElement("option");p.value=r?o[n].id:o[n][e];p.innerHTML=o[n][e];i.appendChild(p);s.push(o[n][e])}}if(s.length){a.innerHTML='<option value="-1">All</option>'}else{a.innerHTML='<option value="-1">-</option>'}a.appendChild(i)}function pfx_sel_to_filter(e){var t;var r;var n={};var a=["group","type","topology"];if(!e){e=[]}for(t=0;t<a.length;++t){if(e.indexOf(a[t])!==-1){continue}r=document.getElementById("pfx-sel-"+a[t]).value;if(r!=-1){n[a[t]]=r}}if(e.indexOf("name")!==-1){return n}r=parseInt(document.getElementById("pfx-sel-name").value);if(!isNaN(r)&&r!=-1&&r>-1&&pfx_config.length>r){n.name=pfx_config[r].name;n.id=r}return n}function update_pfx_vars(e,t){if(!t||!t.hasOwnProperty("file")||!t.hasOwnProperty("checksum")){ns_var_set(e+"-name","-");ns_var_set(e+"-file","-");ns_var_set(e+"-hash","-");ns_var_set(e+"-ver","-");ns_var_set(e+"-ports","-");ns_var_set(e+"-pcie","-");ns_var_set(e+"-protected","-");ns_var_set(e+"-desc","-")}else{var r="";var n;if(t.hasOwnProperty("width")){r+="x"+t.width}if(t.hasOwnProperty("speed")){if(r.length){r+=", "}r+="Gen"+t.speed+" "}if(t.hasOwnProperty("protected")&&t.protected){n="Yes"}else{n="No"}ns_var_set(e+"-name",t.name?t.name:"N/A");ns_var_set(e+"-file",t.file);ns_var_set(e+"-hash",t.checksum);ns_var_set(e+"-ports",t.ports?t.ports:"N/A");ns_var_set(e+"-pcie",r.length?r:"N/A");ns_var_set(e+"-protected",n);ns_var_set(e+"-desc",t.description?t.description:"N/A");var a=t.version?t.version:"N/A";if(e=="ns-active"){if(config.hasOwnProperty("pfxUpdateAvailable")&&(pfx_config&&pfx_config.length>config.pfxUpdateAvailable)){a+='<span class="blink"> - new version '+pfx_config[config.pfxUpdateAvailable].version+" available!</span>";document.getElementById("pfxUpdateAvail").setAttribute("style","display: block;")}else{document.getElementById("pfxUpdateAvail").removeAttribute("style")}}ns_var_set(e+"-ver",a)}}function update_pfx_sel(){var e=parseInt(document.getElementById("pfx-sel-name").value);var t=document.getElementById("btn-burn");if(isNaN(e)||0>e||e>=pfx_config.length){disable(t);update_pfx_vars("ns-sel",{})}else{enable(t);update_pfx_vars("ns-sel",pfx_config[e])}}function load_status(r){if(!r){r=function(e){}}ajax({url:"/api/status",headers:{Authorization:"bearer "+get_token()},success:function(e,t){server=e.server;config=e.config;versions=e.versions;voltage=e.voltage;temperatures=e.temperatures;fans=e.fans;osinfo=e.os;errors=e.errors;portStates=e.ports;update_status();r(null)},error:function(e){r(e)}})}function load_pfx_configs(r){if(!r){r=function(e){}}ajax({url:"/api/pfx/config",headers:{Authorization:"bearer "+get_token()},success:function(e,t){pfx_config=e;r(null)},error:function(e){r(e)}})}function load_config(t){var e=get_token();stop_update_timer();if(!e){window.location.replace("/login.html");return}if(!t){t=function(e){}}load_status(function(e){if(e){if(e==401){window.location.replace("/login.html")}else{popup_error("Error: "+e,"Failed to load server configuration. API may be unavailable")}return t(e)}if(server.busy){t(null);popup("Please wait","Mission critical procedure is in progress. Please wait until completion. "+"The process should complete within 3 - 30 minutes.");if(server.state==="System update in progress"||server.state==="Rebooting system"){allow_api_failure=1}poll_progress();return}load_pfx_configs(function(e){t(e);if(e){popup_error("Error: "+e,"Failed to retrieve server resources. API may be unavailable.",1)}if(server.reboot&&!asked_reboot){asked_reboot=1;popup_select("Reboot required","The management processor needs to be rebooted. "+"Reboot now and refresh the page?",function(e){if(!e){return}reboot(document.getElementById("reboot"),1)})}start_update_timer()})})}function main(){popup("Loading","Loading server resources. Please wait a few seconds.");if(window.location.search.indexOf("hexpert")!==-1){extend=1}load_config(function(e){init_page();popup_close()})}